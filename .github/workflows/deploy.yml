name: Update codelab index

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-entries:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate entries.json
        run: |
          python3 << 'SCRIPT'
          import os, json

          IGNORE = {
              '.git', '.github', '.nojekyll', '.DS_Store',
              'node_modules', 'img', '__pycache__'
          }

          entries = []
          root = '.'

          for name in sorted(os.listdir(root)):
              path = os.path.join(root, name)
              if not os.path.isdir(path):
                  continue
              if name in IGNORE or name.startswith('.'):
                  continue

              # Look for index.html first, then any .html file
              html_file = None
              children = os.listdir(path)
              if 'index.html' in children:
                  html_file = 'index.html'
              else:
                  for child in sorted(children):
                      if child.endswith('.html'):
                          html_file = child
                          break

              if html_file:
                  entries.append({
                      'name': name,
                      'url': f'./{name}/{html_file}'
                  })

          with open('entries.json', 'w') as f:
              json.dump(entries, f, indent=2)

          print(f'Generated entries.json with {len(entries)} codelab(s):')
          for e in entries:
              print(f'  - {e["name"]} -> {e["url"]}')
          SCRIPT

      - name: Commit entries.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add entries.json
          if git diff --cached --quiet; then
            echo "No changes to entries.json"
          else
            git commit -m "Update entries.json [skip ci]"
            git push
          fi
