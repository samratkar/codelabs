name: Update codelab index

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-entries:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate entries.json
        run: |
          python3 << 'SCRIPT'
          import os, json

          IGNORE = {
              '.git', '.github', '.nojekyll', '.DS_Store',
              'node_modules', 'img', '__pycache__'
          }

          entries = []
          root = '.'

          for name in sorted(os.listdir(root)):
              path = os.path.join(root, name)
              if not os.path.isdir(path):
                  continue
              if name in IGNORE or name.startswith('.'):
                  continue

              # Look for index.html first, then any .html file
              html_file = None
              children = os.listdir(path)
              if 'index.html' in children:
                  html_file = 'index.html'
              else:
                  for child in sorted(children):
                      if child.endswith('.html'):
                          html_file = child
                          break

              if html_file:
                  entries.append({
                      'name': name,
                      'url': f'./{name}/{html_file}'
                  })

          with open('entries.json', 'w') as f:
              json.dump(entries, f, indent=2)

          print(f'Generated entries.json with {len(entries)} codelab(s):')
          for e in entries:
              print(f'  - {e["name"]} -> {e["url"]}')
          SCRIPT

      - name: Patch home-url in codelab HTML files
        run: |
          python3 << 'SCRIPT'
          import os, re, glob

          IGNORE = {'.git', '.github', '.nojekyll', '.DS_Store', 'node_modules', 'img', '__pycache__'}
          patched = []

          for html_path in glob.glob('*/**.html', recursive=True):
              folder = html_path.split(os.sep)[0]
              if folder in IGNORE or folder.startswith('.'):
                  continue

              with open(html_path, 'r') as f:
                  content = f.read()

              if '<google-codelab' not in content:
                  continue

              # Already has home-url â€” skip
              if re.search(r'<google-codelab[^>]*home-url=', content):
                  continue

              # Insert home-url="../" into the <google-codelab> tag
              updated = re.sub(
                  r'(<google-codelab\b)',
                  r'\1\n                  home-url="../"',
                  content,
                  count=1
              )

              with open(html_path, 'w') as f:
                  f.write(updated)
              patched.append(html_path)

          if patched:
              print(f'Patched home-url in {len(patched)} file(s):')
              for p in patched:
                  print(f'  - {p}')
          else:
              print('All codelab HTML files already have home-url set.')
          SCRIPT

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add entries.json '*.html'
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update entries.json and patch codelab home-url [skip ci]"
            git push
          fi
